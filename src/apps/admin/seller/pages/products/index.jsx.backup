import React, { useState, useEffect, useMemo } from 'react';
import { useAuth } from '../../../../../contexts/AuthContext';
import SaticiHeader from '../../../../../shared/components/ui/SaticiHeader';
import Icon from '../../../../../shared/components/AppIcon';
import { storage } from '../../../../../utils/persistentStorage';

// Bile≈üenler
import UrunModali from './components/UrunModali';

// Utility function to trigger product updates
const triggerProductsUpdate = () => {
  // Trigger custom event to notify other components
  window.dispatchEvent(new CustomEvent('productsUpdated'));
  
  // Use unified storage for cross-device sync
  storage.broadcastChange('products');
};

const UrunYonetimi = () => {
  const { user, userProfile, loading: authLoading } = useAuth();
  const [loading, setLoading] = useState(true);
  const [products, setProducts] = useState([]);
  const [categories, setCategories] = useState([]);
  const [selectedProducts, setSelectedProducts] = useState([]);
  const [showProductModal, setShowProductModal] = useState(false);
  const [editingProduct, setEditingProduct] = useState(null);
  const [currentPage, setCurrentPage] = useState(1);
  const [activeTab, setActiveTab] = useState('T√ºm √úr√ºnler');
  const [showNewCategoryModal, setShowNewCategoryModal] = useState(false);
  const [newCategoryName, setNewCategoryName] = useState('');
  const itemsPerPage = 12;

  const [filters, setFilters] = useState({
    search: '',
    status: '',
    stockStatus: '',
    sortBy: 'name'
  });

  // Cross-device communication - unified storage events
  useEffect(() => {
    const handleProductsUpdated = (data) => {
      setProducts(data.products || []);
      console.log('üîÑ Products updated via cross-device sync');
    };

    const handleCategoriesUpdated = (data) => {
      setCategories(data.categories || []);
      console.log('üîÑ Categories updated via cross-device sync');
    };

    // Listen for unified storage changes
    const unsubscribeProducts = storage.subscribe('products', handleProductsUpdated);
    const unsubscribeCategories = storage.subscribe('categories', handleCategoriesUpdated);

    return () => {
      unsubscribeProducts();
      unsubscribeCategories();
    };
  }, []);

  // Demo veriler - kategoriler ile birlikte √ºr√ºnler
  useEffect(() => {
    const loadData = async () => {
      console.log('üîÑ √úr√ºn y√∂netimi verileri y√ºkleniyor...');
      
      try {
        // Unified storage'dan verileri y√ºkle
        const [storedProducts, storedCategories] = await Promise.all([
          storage.get('products', []),
          storage.get('categories', [])
        ]);

        console.log('üìä Storage\'dan y√ºklenen veriler:', {
          productsCount: storedProducts.length,
          categoriesCount: storedCategories.length
        });

        // Kategorileri ayarla
        if (storedCategories.length === 0) {
          console.log('üÜï Varsayƒ±lan kategoriler olu≈üturuluyor...');
          const defaultCategories = [
            {
              id: 1,
              name: 'T√ºm √úr√ºnler',
              icon: 'Package',
              color: 'gray',
              subcategories: []
            },
            {
              id: 2,
              name: 'Sebzeler',
              icon: 'Leaf',
              color: 'green',
              subcategories: ['Ye≈üil Yapraklƒ±lar', 'K√∂k Sebzeler', 'Mevsim Sebzeleri']
            },
            {
              id: 3,
              name: 'Meyveler',
              icon: 'Apple',
              color: 'red',
              subcategories: ['Turun√ßgiller', 'Tropik Meyveler', 'Yumu≈üak Meyveler']
            },
            {
              id: 4,
              name: 'Kuru Yemi≈ü',
              icon: 'Nut',
              color: 'amber',
              subcategories: ['√áiƒü Kuruyemi≈ü', 'Kurutulmu≈ü Meyve']
            }
          ];
          
          await storage.set('categories', defaultCategories);
          setCategories(defaultCategories);
        } else {
          setCategories(storedCategories);
        }

        // √úr√ºnleri ayarla
        if (storedProducts.length === 0) {
          console.log('üÜï Demo √ºr√ºnler olu≈üturuluyor...');
          // Detaylƒ± demo √ºr√ºnler buraya gelecek
          const demoProducts = [
            {
              id: 1,
              name: 'Domates',
              category: 'Sebzeler',
              subcategory: 'Mevsim Sebzeleri',
              unit: 'kg',
              price: 18.00,
              stock: 25,
              minStock: 5,
              status: 'active',
              image: '/assets/images/products/Domates.png',
              description: 'Taze, kƒ±rmƒ±zƒ±, lezzetli domates'
            },
            {
              id: 2,
              name: 'Elma',
              category: 'Meyveler',
              subcategory: 'Yumu≈üak Meyveler',
              unit: 'kg',
              price: 15.00,
              stock: 40,
              minStock: 10,
              status: 'active',
              image: '/assets/images/products/Elma.png',
              description: 'Kƒ±rmƒ±zƒ±, tatlƒ± ve sulu elma'
            }
          ];
          
          await storage.set('products', demoProducts);
          setProducts(demoProducts);
        } else {
          setProducts(storedProducts);
        }

        console.log('‚úÖ √úr√ºn y√∂netimi verileri ba≈üarƒ±yla y√ºklendi');
        
      } catch (error) {
        console.error('‚ùå √úr√ºn y√∂netimi veri y√ºkleme hatasƒ±:', error);
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, []);
      
      // Global test fonksiyonlarƒ±
      window.testAddProduct = () => {
        const products = storage.get('products', []);
        const newProduct = {
          id: Date.now(),
          name: 'Test √úr√ºn ' + Math.floor(Math.random() * 1000),
          category: 'Test',
          subcategory: 'Test Alt',
          unit: 'adet',
          price: Math.floor(Math.random() * 50) + 10,
          stock: Math.floor(Math.random() * 20) + 5,
          minStock: 2,
          status: 'active',
          image: '/assets/images/products/Elma.png',
          description: 'Test √ºr√ºn√º - cross-browser sync testi'
        };
        products.push(newProduct);
        storage.set('products', products);
        console.log('‚úÖ Test √ºr√ºn eklendi:', newProduct.name);
      };
      
      window.testRemoveLastProduct = () => {
        const products = storage.get('products', []);
        if (products.length > 0) {
          const removed = products.pop();
          storage.set('products', products);
          console.log('üóëÔ∏è Son √ºr√ºn silindi:', removed.name);
        }
      };
      
      window.testClearStorage = () => {
        storage.clear();
        window.location.reload();
        console.log('üßπ Storage temizlendi ve sayfa yenilendi');
      };
      
      window.testForceReload = () => {
        storage.set('products', []);
        window.location.reload();
        console.log('ÔøΩ Products sƒ±fƒ±rlandƒ± ve sayfa yenilendi');
      };
      
      console.log('ÔøΩüîß Test fonksiyonlarƒ± hazƒ±r: testAddProduct(), testRemoveLastProduct(), testClearStorage(), testForceReload()');
      
      
      // Kategorileri y√ºkle - unified storage kullan
      let mockCategories = storage.get('categories', null);
      
      if (!mockCategories || !Array.isArray(mockCategories) || mockCategories.length === 0) {
        console.log('üÜï Varsayƒ±lan kategoriler olu≈üturuluyor...');
        mockCategories = [
          {
            id: 1,
            name: 'T√ºm √úr√ºnler',
            icon: 'Package',
            color: 'gray',
            subcategories: []
          },
          {
            id: 2,
            name: 'Sebzeler',
            icon: 'Leaf',
            color: 'green',
            subcategories: ['Ye≈üil Yapraklƒ±lar', 'K√∂k Sebzeler', 'Mevsim Sebzeleri']
          },
          {
            id: 3,
            name: 'Meyveler',
            icon: 'Apple',
            color: 'red',
            subcategories: ['Turun√ßgiller', '√áekirdekli Meyveler', 'Tropik Meyveler']
          }
        ];
        storage.set('categories', mockCategories);
      }

      // √úr√ºnleri y√ºkle - unified storage kullan
      let loadedProducts = storage.get('products', []);
      
      // √úr√ºnler bo≈ü veya ge√ßersizse demo verilerini y√ºkle
      if (!Array.isArray(loadedProducts) || loadedProducts.length === 0) {
        console.log('üÜï Ger√ßek √ºr√ºnleri olu≈üturuluyor...');
        loadedProducts = [
          // MEYVELER
          {
            id: 1,
            name: 'Ananas',
            category: 'Meyveler',
            subcategory: 'Tropik Meyveler',
            unit: 'adet',
            price: 45.00,
            stock: 8,
            minStock: 2,
            status: 'active',
            image: '/assets/images/products/Ananas.png',
            description: 'Taze tropik ananas, C vitamini a√ßƒ±sƒ±ndan zengin'
          },
          {
            id: 2,
            name: 'Elma',
            category: 'Meyveler',
            subcategory: '√áekirdekli Meyveler',
            unit: 'kg',
            price: 18.00,
            stock: 45,
            minStock: 10,
            status: 'active',
            image: '/assets/images/products/Elma.png',
            description: 'Kƒ±rmƒ±zƒ± starking elma, taze ve gevrek'
          },
          {
            id: 3,
            name: 'Ye≈üil Elma',
            category: 'Meyveler',
            subcategory: '√áekirdekli Meyveler',
            unit: 'kg',
            price: 16.00,
            stock: 32,
            minStock: 8,
            status: 'active',
            image: '/assets/images/products/Ye≈üil Elma.png',
            description: 'Granny Smith ye≈üil elma, ek≈üi ve saƒülƒ±klƒ±'
          },
          {
            id: 4,
            name: 'Portakal',
            category: 'Meyveler',
            subcategory: 'Turun√ßgiller',
            unit: 'kg',
            price: 20.00,
            stock: 28,
            minStock: 6,
            status: 'active',
            image: '/assets/images/products/Portakal.png',
            description: 'Valencia portakalƒ±, vitamin C deposu'
          },
          {
            id: 5,
            name: 'Limon',
            category: 'Meyveler',
            subcategory: 'Turun√ßgiller',
            unit: 'kg',
            price: 25.00,
            stock: 15,
            minStock: 4,
            status: 'active',
            image: '/assets/images/products/Limon.png',
            description: 'Akdeniz limonu, ferahlatƒ±cƒ± ve aromatik'
          },
          {
            id: 6,
            name: 'Mandalina',
            category: 'Meyveler',
            subcategory: 'Turun√ßgiller',
            unit: 'kg',
            price: 22.00,
            stock: 20,
            minStock: 5,
            status: 'active',
            image: '/assets/images/products/Mandalina.png',
            description: 'Satsuma mandalina, kolay soyulur'
          },
          {
            id: 7,
            name: 'Muz',
            category: 'Meyveler',
            subcategory: 'Tropik Meyveler',
            unit: 'kg',
            price: 14.00,
            stock: 35,
            minStock: 8,
            status: 'active',
            image: '/assets/images/products/Muz.png',
            description: 'Cavendish muz, potasyum deposu'
          },
          {
            id: 8,
            name: '√áilek',
            category: 'Meyveler',
            subcategory: 'Yaban Meyveleri',
            unit: 'kasede',
            price: 35.00,
            stock: 12,
            minStock: 3,
            status: 'active',
            image: '/assets/images/products/√áilek.png',
            description: 'Serada yeti≈üen taze √ßilek, antioksidan'
          },
          {
            id: 9,
            name: '√úz√ºm',
            category: 'Meyveler',
            subcategory: 'Asma Meyveleri',
            unit: 'kg',
            price: 30.00,
            stock: 18,
            minStock: 4,
            status: 'active',
            image: '/assets/images/products/√úz√ºm.png',
            description: 'Sultani √ºz√ºm, tatlƒ± ve √ßekirdeksiz'
          },
          {
            id: 10,
            name: 'Kivi',
            category: 'Meyveler',
            subcategory: 'Tropik Meyveler',
            unit: 'adet',
            price: 3.50,
            stock: 40,
            minStock: 10,
            status: 'active',
            image: '/assets/images/products/Kivi.png',
            description: 'Yeni Zelanda kivisi, E vitamini'
          },
          {
            id: 11,
            name: 'Avokado',
            category: 'Meyveler',
            subcategory: 'Tropik Meyveler',
            unit: 'adet',
            price: 8.00,
            stock: 25,
            minStock: 6,
            status: 'active',
            image: '/assets/images/products/Avakado.png',
            description: 'Hass avokado, saƒülƒ±klƒ± yaƒülar'
          },
          {
            id: 12,
            name: '≈ûeftali',
            category: 'Meyveler',
            subcategory: '√áekirdekli Meyveler',
            unit: 'kg',
            price: 28.00,
            stock: 22,
            minStock: 5,
            status: 'active',
            image: '/assets/images/products/≈ûeftali.png',
            description: 'B√ºy√ºk ≈üeftali, sulu ve tatlƒ±'
          },
          {
            id: 13,
            name: 'Kayƒ±sƒ±',
            category: 'Meyveler',
            subcategory: '√áekirdekli Meyveler',
            unit: 'kg',
            price: 45.00,
            stock: 8,
            minStock: 2,
            status: 'active',
            image: '/assets/images/products/Kayƒ±sƒ±.png',
            description: 'Malatya kayƒ±sƒ±sƒ±, beta karoten'
          },
          {
            id: 14,
            name: 'Kiraz',
            category: 'Meyveler',
            subcategory: '√áekirdekli Meyveler',
            unit: 'kg',
            price: 55.00,
            stock: 6,
            minStock: 2,
            status: 'active',
            image: '/assets/images/products/Kiraz.png',
            description: 'Napoleon kiraz, iri ve tatlƒ±'
          },
          {
            id: 15,
            name: 'ƒ∞ncir',
            category: 'Meyveler',
            subcategory: 'Yaban Meyveleri',
            unit: 'kg',
            price: 40.00,
            stock: 10,
            minStock: 3,
            status: 'active',
            image: '/assets/images/products/ƒ∞ncir.png',
            description: 'Bursa siyah inciri, mineral deposu'
          },
          {
            id: 16,
            name: 'Nar',
            category: 'Meyveler',
            subcategory: 'Yaban Meyveleri',
            unit: 'adet',
            price: 12.00,
            stock: 15,
            minStock: 4,
            status: 'active',
            image: '/assets/images/products/Nar.png',
            description: 'Ek≈üi nar, antioksidan deposu'
          },
          {
            id: 17,
            name: 'Nektarin',
            category: 'Meyveler',
            subcategory: '√áekirdekli Meyveler',
            unit: 'kg',
            price: 32.00,
            stock: 14,
            minStock: 3,
            status: 'active',
            image: '/assets/images/products/nectarine.png',
            description: 'T√ºys√ºz ≈üeftali, aromalƒ±'
          },
          {
            id: 18,
            name: 'Armut',
            category: 'Meyveler',
            subcategory: '√áekirdekli Meyveler',
            unit: 'kg',
            price: 24.00,
            stock: 20,
            minStock: 5,
            status: 'active',
            image: '/assets/images/products/Armut.png',
            description: 'Ankara armut, sulu ve gevrek'
          },
          {
            id: 19,
            name: 'Kavun',
            category: 'Meyveler',
            subcategory: 'Kavunumsu Meyveler',
            unit: 'adet',
            price: 15.00,
            stock: 12,
            minStock: 3,
            status: 'active',
            image: '/assets/images/products/Kavun.png',
            description: 'Yuva kavunu, yaz meyvesi'
          },
          {
            id: 20,
            name: 'Greyfurt',
            category: 'Meyveler',
            subcategory: 'Turun√ßgiller',
            unit: 'adet',
            price: 8.50,
            stock: 18,
            minStock: 4,
            status: 'active',
            image: '/assets/images/products/Greyfurt.png',
            description: 'Pembe greyfurt, metabolizma hƒ±zlandƒ±rƒ±cƒ±'
          },
          {
            id: 21,
            name: 'Lime',
            category: 'Meyveler',
            subcategory: 'Turun√ßgiller',
            unit: 'adet',
            price: 2.50,
            stock: 30,
            minStock: 8,
            status: 'active',
            image: '/assets/images/products/Lime.png',
            description: 'Ye≈üil lime, kokteyl ve salata i√ßin'
          },
          {
            id: 22,
            name: 'Ayva',
            category: 'Meyveler',
            subcategory: '√áekirdekli Meyveler',
            unit: 'kg',
            price: 20.00,
            stock: 15,
            minStock: 4,
            status: 'active',
            image: '/assets/images/products/Ayva.png',
            description: 'Ekmek ayva, re√ßel ve marmelat i√ßin'
          },
          
          // SEBZELER
          {
            id: 23,
            name: 'Domates',
            category: 'Sebzeler',
            subcategory: 'Mevsim Sebzeleri',
            unit: 'kg',
            price: 16.00,
            stock: 50,
            minStock: 12,
            status: 'active',
            image: '/assets/images/products/Domates.png',
            description: 'Sera domates, likopen deposu'
          },
          {
            id: 24,
            name: 'Salatalƒ±k',
            category: 'Sebzeler',
            subcategory: 'Mevsim Sebzeleri',
            unit: 'kg',
            price: 12.00,
            stock: 35,
            minStock: 8,
            status: 'active',
            image: '/assets/images/products/Salatalƒ±k.png',
            description: 'Sera salatalƒ±k, ferahlatƒ±cƒ±'
          },
          {
            id: 25,
            name: 'Kƒ±rmƒ±zƒ± Biber',
            category: 'Sebzeler',
            subcategory: 'Mevsim Sebzeleri',
            unit: 'kg',
            price: 28.00,
            stock: 20,
            minStock: 5,
            status: 'active',
            image: '/assets/images/products/Kƒ±rmƒ±zƒ± Biber.png',
            description: 'Dolmalƒ±k kƒ±rmƒ±zƒ± biber, C vitamini'
          },
          {
            id: 26,
            name: 'Patates',
            category: 'Sebzeler',
            subcategory: 'K√∂k Sebzeler',
            unit: 'kg',
            price: 8.00,
            stock: 80,
            minStock: 20,
            status: 'active',
            image: '/assets/images/products/patates.png',
            description: 'Granola patates, karbonhidrat kaynaƒüƒ±'
          },
          {
            id: 27,
            name: 'Soƒüan',
            category: 'Sebzeler',
            subcategory: 'K√∂k Sebzeler',
            unit: 'kg',
            price: 6.00,
            stock: 60,
            minStock: 15,
            status: 'active',
            image: '/assets/images/products/sogan-cuval.png',
            description: 'Kuru soƒüan √ßuval, mutfaƒüƒ±n vazge√ßilmezi'
          },
          {
            id: 28,
            name: 'Sarƒ±msak',
            category: 'Sebzeler',
            subcategory: 'Baharat Sebzeleri',
            unit: 'kg',
            price: 35.00,
            stock: 12,
            minStock: 3,
            status: 'active',
            image: '/assets/images/products/Sarƒ±msak.png',
            description: 'Kuru sarƒ±msak, doƒüal antibiyotik'
          },
          {
            id: 29,
            name: 'Lahana',
            category: 'Sebzeler',
            subcategory: 'Ye≈üil Yapraklƒ±lar',
            unit: 'adet',
            price: 8.00,
            stock: 25,
            minStock: 6,
            status: 'active',
            image: '/assets/images/products/lahana.png',
            description: 'Beyaz lahana, dolma ve tur≈üu i√ßin'
          },
          {
            id: 30,
            name: 'Kabak',
            category: 'Sebzeler',
            subcategory: 'Mevsim Sebzeleri',
            unit: 'kg',
            price: 10.00,
            stock: 30,
            minStock: 8,
            status: 'active',
            image: '/assets/images/products/kabak.png',
            description: 'Beyaz kabak, d√º≈ü√ºk kalorili'
          },
          {
            id: 31,
            name: 'Kereviz',
            category: 'Sebzeler',
            subcategory: 'K√∂k Sebzeler',
            unit: 'kg',
            price: 18.00,
            stock: 15,
            minStock: 4,
            status: 'active',
            image: '/assets/images/products/Kereviz.png',
            description: 'Taze kereviz, detoks etkili'
          },
          {
            id: 32,
            name: 'Kƒ±vƒ±rcƒ±k Salata',
            category: 'Sebzeler',
            subcategory: 'Ye≈üil Yapraklƒ±lar',
            unit: 'demet',
            price: 5.00,
            stock: 40,
            minStock: 10,
            status: 'active',
            image: '/assets/images/products/Kƒ±vƒ±rcƒ±k.png',
            description: 'Kƒ±vƒ±rcƒ±k marul, vitamin deposu'
          },
          {
            id: 33,
            name: 'Roka',
            category: 'Sebzeler',
            subcategory: 'Ye≈üil Yapraklƒ±lar',
            unit: 'demet',
            price: 4.50,
            stock: 35,
            minStock: 8,
            status: 'active',
            image: '/assets/images/products/Roka.png',
            description: 'Taze roka, acƒ±msƒ± lezzet'
          },
          {
            id: 34,
            name: 'Tere Otu',
            category: 'Sebzeler',
            subcategory: 'Ye≈üil Yapraklƒ±lar',
            unit: 'demet',
            price: 3.00,
            stock: 45,
            minStock: 12,
            status: 'active',
            image: '/assets/images/products/TereOtu.png',
            description: 'Taze tere otu, folik asit'
          },
          {
            id: 35,
            name: 'Mantar',
            category: 'Sebzeler',
            subcategory: 'Mantarlar',
            unit: 'kg',
            price: 25.00,
            stock: 18,
            minStock: 4,
            status: 'active',
            image: '/assets/images/products/Mantar.png',
            description: 'Beyaz mantar, protein kaynaƒüƒ±'
          },
          {
            id: 36,
            name: 'Mƒ±sƒ±r',
            category: 'Sebzeler',
            subcategory: 'Tahƒ±l Sebzeleri',
            unit: 'adet',
            price: 4.00,
            stock: 30,
            minStock: 8,
            status: 'active',
            image: '/assets/images/products/Darƒ±Mƒ±sƒ±r.png',
            description: 'Tatlƒ± mƒ±sƒ±r, lif kaynaƒüƒ±'
          }
        ];
        
        storage.set('products', loadedProducts);
        console.log('üÜï Ger√ßek √ºr√ºnler olu≈üturuldu:', loadedProducts.length);
      } else {
        console.log('üì¶ Mevcut √ºr√ºnler y√ºklendi:', loadedProducts.length);
      }

      setProducts(loadedProducts);
      setCategories(mockCategories);
      setLoading(false);
      console.log('‚úÖ Veri y√ºkleme tamamlandƒ±');
    };

    loadData();
  }, []);

  // √úr√ºnler deƒüi≈ütiƒüinde localStorage'a kaydet ve event dispatch et
  // NOT: Bu useEffect kaldƒ±rƒ±ldƒ± √ß√ºnk√º infinite loop yaratƒ±yordu
  // Artƒ±k √ºr√ºnler sadece manuel deƒüi≈üikliklerde (create/edit/delete) kaydedilecek

  // Aktif sekmeye g√∂re filtrelenmi≈ü √ºr√ºnler
  const filteredProducts = useMemo(() => {
    let filtered = activeTab === 'T√ºm √úr√ºnler' ? products : products.filter(product => product.category === activeTab);

    // Arama filtresi
    if (filters.search) {
      const searchLower = filters.search.toLowerCase();
      filtered = filtered.filter(product =>
        product.name.toLowerCase().includes(searchLower) ||
        product.subcategory.toLowerCase().includes(searchLower) ||
        product.description.toLowerCase().includes(searchLower)
      );
    }

    // Durum filtresi
    if (filters.status) {
      filtered = filtered.filter(product => product.status === filters.status);
    }

    // Stok durumu filtresi
    if (filters.stockStatus) {
      switch (filters.stockStatus) {
        case 'low':
          filtered = filtered.filter(product => product.stock > 0 && product.stock <= product.minStock);
          break;
        case 'out':
          filtered = filtered.filter(product => product.stock === 0);
          break;
        case 'normal':
          filtered = filtered.filter(product => product.stock > product.minStock);
          break;
      }
    }

    // Sƒ±ralama
    filtered.sort((a, b) => {
      switch (filters.sortBy) {
        case 'name':
          return a.name.localeCompare(b.name);
        case 'price_high':
          return b.price - a.price;
        case 'price_low':
          return a.price - b.price;
        case 'stock_high':
          return b.stock - a.stock;
        case 'stock_low':
          return a.stock - b.stock;
        default:
          return 0;
      }
    });

    return filtered;
  }, [products, activeTab, filters]);

  // Sayfalama
  const paginatedProducts = useMemo(() => {
    const startIndex = (currentPage - 1) * itemsPerPage;
    return filteredProducts.slice(startIndex, startIndex + itemsPerPage);
  }, [filteredProducts, currentPage]);

  const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);

  // Aktif sekme istatistikleri
  const tabStatistics = useMemo(() => {
    const categoryProducts = activeTab === 'T√ºm √úr√ºnler' ? products : products.filter(product => product.category === activeTab);
    const totalProducts = categoryProducts.length;
    const activeProducts = categoryProducts.filter(product => product.status === 'active').length;
    const inactiveProducts = categoryProducts.filter(product => product.status === 'inactive').length;
    const lowStockProducts = categoryProducts.filter(product => product.stock > 0 && product.stock <= product.minStock).length;
    const outOfStockProducts = categoryProducts.filter(product => product.stock === 0).length;
    const totalValue = categoryProducts.reduce((sum, product) => sum + (product.price * product.stock), 0);

    return {
      totalProducts,
      activeProducts,
      inactiveProducts,
      lowStockProducts,
      outOfStockProducts,
      totalValue
    };
  }, [products, activeTab]);

  // Para formatƒ±
  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: 'TRY'
    }).format(amount);
  };

  // Stok durumu rengini al
  const getStockStatusColor = (product) => {
    if (product.stock === 0) return 'bg-red-100 text-red-800';
    if (product.stock <= product.minStock) return 'bg-yellow-100 text-yellow-800';
    return 'bg-green-100 text-green-800';
  };

  // Stok durumu metni
  const getStockStatusText = (product) => {
    if (product.stock === 0) return 'T√ºkendi';
    if (product.stock <= product.minStock) return 'Az Stok';
    return 'Normal';
  };

  // Durum rengini al
  const getStatusColor = (status) => {
    return status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
  };

  // Durum metni
  const getStatusText = (status) => {
    return status === 'active' ? 'Aktif' : 'Pasif';
  };

  // Kategori rengini al
  const getCategoryColor = (color) => {
    const colors = {
      green: 'bg-green-100 text-green-800 border-green-200',
      red: 'bg-red-100 text-red-800 border-red-200',
      brown: 'bg-yellow-100 text-yellow-800 border-yellow-200',
      blue: 'bg-blue-100 text-blue-800 border-blue-200'
    };
    return colors[color] || 'bg-gray-100 text-gray-800 border-gray-200';
  };

  // Filtre deƒüi≈üikliƒüi
  const handleFilterChange = (newFilters) => {
    setFilters({ ...filters, ...newFilters });
    setCurrentPage(1);
  };

  // Filtreleri sƒ±fƒ±rla
  const handleResetFilters = () => {
    setFilters({
      search: '',
      status: '',
      stockStatus: '',
      sortBy: 'name'
    });
    setCurrentPage(1);
  };

  // Sekme deƒüi≈üikliƒüi
  const handleTabChange = (categoryName) => {
    setActiveTab(categoryName);
    setCurrentPage(1);
    setSelectedProducts([]);
    handleResetFilters();
  };

  // Yeni kategori ekleme
  const handleAddCategory = () => {
    const trimmedName = newCategoryName.trim();
    
    if (!trimmedName) {
      window.showToast && window.showToast('Kategori adƒ± bo≈ü olamaz', 'error');
      return;
    }
    
    if (trimmedName.length < 2) {
      window.showToast && window.showToast('Kategori adƒ± en az 2 karakter olmalƒ±dƒ±r', 'error');
      return;
    }
    
    if (categories.find(cat => cat.name.toLowerCase() === trimmedName.toLowerCase())) {
      window.showToast && window.showToast('Bu kategori zaten mevcut', 'error');
      return;
    }
    
    try {
      const newCategory = {
        id: Math.max(...categories.map(c => c.id)) + 1,
        name: trimmedName,
        icon: 'Package',
        color: 'blue',
        subcategories: ['Genel']
      };
      const updatedCategories = [...categories, newCategory];
      setCategories(updatedCategories);
      
      // Unified storage'a kaydet (cross-device sync ile)
      storage.set('categories', updatedCategories);
      
      setActiveTab(newCategory.name);
      setNewCategoryName('');
      setShowNewCategoryModal(false);
      window.showToast && window.showToast('Kategori ba≈üarƒ±yla eklendi', 'success');
    } catch (error) {
      console.error('Error adding category:', error);
      window.showToast && window.showToast('Kategori eklenirken hata olu≈ütu', 'error');
    }
  };

  // Kategori silme
  const handleDeleteCategory = (categoryToDelete) => {
    // Kategorideki √ºr√ºn sayƒ±sƒ±nƒ± kontrol et
    const categoryProducts = products.filter(p => p.category === categoryToDelete.name);
    
    if (categoryProducts.length > 0) {
      alert(`Bu kategoride ${categoryProducts.length} √ºr√ºn bulunuyor. √ñnce √ºr√ºnleri silmeniz veya ba≈üka kategoriye ta≈üƒ±manƒ±z gerekiyor.`);
      return;
    }

    if (categories.length <= 1) {
      alert('En az bir kategori bulunmalƒ±dƒ±r.');
      return;
    }

    if (window.confirm(`"${categoryToDelete.name}" kategorisini silmek istediƒüinizden emin misiniz?`)) {
      const updatedCategories = categories.filter(cat => cat.id !== categoryToDelete.id);
      setCategories(updatedCategories);
      
      // Unified storage'a kaydet (cross-device sync ile)
      storage.set('categories', updatedCategories);
      
      // Eƒüer silinen kategori aktif sekme ise, ilk kategoriye ge√ß
      if (activeTab === categoryToDelete.name) {
        setActiveTab(updatedCategories[0].name);
      }
      
      window.showToast && window.showToast('Kategori ba≈üarƒ±yla silindi', 'success');
    }
  };

  // Satƒ±cƒ± deƒüilse y√∂nlendir
  useEffect(() => {
    if (!authLoading && userProfile && userProfile.role !== 'seller' && userProfile.role !== 'admin') {
      window.location.href = '/customer/catalog';
    }
  }, [authLoading, userProfile]);

  const handleAddProduct = () => {
    setEditingProduct(null);
    setShowProductModal(true);
  };

  const handleEditProduct = (product) => {
    setEditingProduct(product);
    setShowProductModal(true);
  };

  const handleDeleteProduct = async (productId) => {
    if (window.confirm('Bu √ºr√ºn√º silmek istediƒüinizden emin misiniz?')) {
      try {
        const currentProducts = await storage.get('products', []);
        const updatedProducts = currentProducts.filter(p => p.id !== productId);
        await storage.set('products', updatedProducts);
        setProducts(updatedProducts);
        
        // Show success toast
        console.log('‚úÖ √úr√ºn ba≈üarƒ±yla silindi:', productId);
      } catch (error) {
        console.error('‚ùå √úr√ºn silme hatasƒ±:', error);
      }
    }
  };

  const handleSaveProduct = async (productData) => {
    console.log('üîç handleSaveProduct √ßaƒürƒ±ldƒ±:', productData);
    
    try {
      const currentProducts = await storage.get('products', []);
      let updatedProducts;
      
      if (editingProduct) {
        // D√ºzenleme
        updatedProducts = currentProducts.map(p => 
          p.id === editingProduct.id ? { 
            ...productData, 
            id: editingProduct.id,
            updatedAt: new Date().toISOString()
          } : p
        );
        console.log('üîç √úr√ºn g√ºncellendi:', editingProduct.id);
      } else {
        // Yeni ekleme - g√ºvenli ID olu≈üturma
        const newId = currentProducts.length > 0 ? Math.max(...currentProducts.map(p => p.id)) + 1 : 1;
        const newProduct = {
          ...productData,
          id: newId,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        console.log('üîç Yeni √ºr√ºn olu≈üturuluyor:', newProduct);
        updatedProducts = [...currentProducts, newProduct];
      }
      
      console.log('üîç G√ºncellenecek t√ºm √ºr√ºnler:', updatedProducts.length);
      
      // Unified storage'a kaydet (cross-device sync ile)
      await storage.set('products', updatedProducts);
      setProducts(updatedProducts);
      
      console.log('‚úÖ √úr√ºn ba≈üarƒ±yla kaydedildi');
      
      setShowProductModal(false);
      setEditingProduct(null);
      
    } catch (error) {
      console.error('‚ùå √úr√ºn kaydetme hatasƒ±:', error);
    }
  };

  const handleBulkAction = (action) => {
    let updatedProducts;
    
    switch (action) {
      case 'activate':
        updatedProducts = products.map(p => 
          selectedProducts.includes(p.id) ? { ...p, status: 'active', updatedAt: new Date().toISOString() } : p
        );
        break;
      case 'deactivate':
        updatedProducts = products.map(p => 
          selectedProducts.includes(p.id) ? { ...p, status: 'inactive', updatedAt: new Date().toISOString() } : p
        );
        break;
      case 'delete':
        if (window.confirm(`${selectedProducts.length} √ºr√ºn√º silmek istediƒüinizden emin misiniz?`)) {
          updatedProducts = products.filter(p => !selectedProducts.includes(p.id));
        } else {
          return; // ƒ∞ptal edildi, i≈ülem yapma
        }
        break;
      default:
        return;
    }
    
    setProducts(updatedProducts);
    storage.set('products', updatedProducts);
    setSelectedProducts([]);
  };

  const handleImageUpload = (e, productId) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const imageData = event.target.result;
        const updatedProducts = products.map(p => 
          p.id === productId ? { ...p, image: imageData } : p
        );
        setProducts(updatedProducts);
        storage.set('products', updatedProducts);
      };
      reader.readAsDataURL(file);
    }
  };

  if (authLoading || loading) {
    return (
      <div className="min-h-screen bg-slate-200 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-green-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">√úr√ºnler y√ºkleniyor...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-200">
      <SaticiHeader />
      
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Ba≈ülƒ±k Bandƒ± */}
        <div className="bg-slate-100 rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <Icon name="Package" size={24} className="text-purple-600" />
              <div>
                <h1 className="text-2xl font-bold text-purple-600">√úr√ºn Y√∂netimi</h1>
                <p className="text-gray-600 mt-1">√úr√ºnlerinizi ve kategorilerinizi y√∂netin</p>
              </div>
            </div>
            
            <div className="flex items-center space-x-3">
              <button
                onClick={() => {
                  if (confirm('T√ºm cache temizlenecek ve sayfa yenilenecek. Devam etmek istiyor musunuz?')) {
                    resetApplication();
                  }
                }}
                className="flex items-center space-x-2 px-4 py-2 border border-red-300 rounded-lg hover:bg-red-50/50 transition-colors bg-transparent text-red-600"
                title="Cache temizle ve uygulamayƒ± sƒ±fƒ±rla"
              >
                <Icon name="Trash2" size={18} />
                <span>Cache Temizle</span>
              </button>
              
              <button
                onClick={handleResetFilters}
                className="flex items-center space-x-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50/50 transition-colors bg-transparent"
              >
                <Icon name="RefreshCw" size={18} />
                <span>Filtreleri Sƒ±fƒ±rla</span>
              </button>
            </div>
          </div>
        </div>

        {/* ƒ∞statistikler */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          <div className="bg-slate-100 rounded-lg p-6 shadow-sm border border-gray-200">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <Icon name="Package" size={24} className="text-blue-600" />
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-500">Toplam √úr√ºn</p>
                <p className="text-2xl font-bold text-gray-900">{tabStatistics.totalProducts}</p>
              </div>
            </div>
          </div>

          <div className="bg-slate-100 rounded-lg p-6 shadow-sm border border-gray-200">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <Icon name="CheckCircle" size={24} className="text-green-600" />
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-500">Aktif √úr√ºn</p>
                <p className="text-2xl font-bold text-gray-900">{tabStatistics.activeProducts}</p>
              </div>
            </div>
          </div>

          <div className="bg-slate-100 rounded-lg p-6 shadow-sm border border-gray-200">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <Icon name="AlertTriangle" size={24} className="text-red-600" />
              </div>
              <div className="ml-4">
                <p className="text-sm font-medium text-gray-500">D√º≈ü√ºk Stok</p>
                <p className="text-2xl font-bold text-gray-900">{tabStatistics.lowStockProducts}</p>
              </div>
            </div>
          </div>


        </div>

        {/* Kategori Tablarƒ± */}
        <div className="bg-slate-100 rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
          <div className="flex flex-wrap gap-3 items-center justify-between">
            <div className="flex flex-wrap gap-3">
              {categories.map((category) => (
                <div key={category.id} className="flex items-center space-x-1">
                  <button
                    onClick={() => setActiveTab(category.name)}
                    className={`flex items-center space-x-2 px-4 py-2 rounded-lg font-medium transition-colors ${
                      activeTab === category.name
                        ? 'bg-green-500/30 text-green-800 border-2 border-green-400/50'
                        : 'bg-gray-100 text-gray-700 hover:bg-green-500/20 hover:text-green-700 border-2 border-transparent'
                    }`}
                  >
                    <Icon name={category.icon} size={16} />
                    <span>{category.name}</span>
                    <span className="bg-white px-2 py-0.5 rounded-full text-xs font-bold">
                      {category.name === 'T√ºm √úr√ºnler' 
                        ? products.length 
                        : products.filter(p => p.category === category.name).length}
                    </span>
                  </button>
                  {category.name !== 'T√ºm √úr√ºnler' && (
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        handleDeleteCategory(category.name);
                      }}
                      className="p-1 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-full transition-colors bg-transparent"
                      title="Kategoriyi Sil"
                    >
                      <Icon name="X" size={14} />
                    </button>
                  )}
                </div>
              ))}
            </div>
            
            <button
              onClick={() => setShowNewCategoryModal(true)}
              className="flex items-center space-x-2 px-4 py-2 bg-green-500/30 text-green-800 hover:bg-green-500/40 rounded-lg font-medium border-2 border-green-400/50 transition-colors"
            >
              <Icon name="Plus" size={16} />
              <span>Yeni Kategori</span>
            </button>
          </div>
        </div>

        {/* Filtreler */}
        <div className="bg-slate-100 rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {/* Arama */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Arama
              </label>
              <div className="relative">
                <Icon name="Search" size={20} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                <input
                  type="text"
                  value={filters.search}
                  onChange={(e) => handleFilterChange({ search: e.target.value })}
                  placeholder="√úr√ºn adƒ± ara..."
                  className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
              </div>
            </div>

            {/* Durum */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Durum
              </label>
              <select
                value={filters.status}
                onChange={(e) => handleFilterChange({ status: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
              >
                <option value="">T√ºm Durumlar</option>
                <option value="active">Aktif</option>
                <option value="inactive">Pasif</option>
              </select>
            </div>

            {/* Stok Durumu */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Stok Durumu
              </label>
              <select
                value={filters.stockStatus}
                onChange={(e) => handleFilterChange({ stockStatus: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
              >
                <option value="">T√ºm Stoklar</option>
                <option value="inStock">Stokta Var</option>
                <option value="lowStock">D√º≈ü√ºk Stok</option>
                <option value="outOfStock">Stokta Yok</option>
              </select>
            </div>

            {/* Sƒ±ralama */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Sƒ±ralama
              </label>
              <select
                value={filters.sortBy}
                onChange={(e) => handleFilterChange({ sortBy: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
              >
                <option value="name">√úr√ºn Adƒ±</option>
                <option value="price">Fiyat</option>
                <option value="stock">Stok</option>
                <option value="category">Kategori</option>
              </select>
            </div>
          </div>

          {/* Filtre Butonlarƒ± */}
          <div className="mt-4 flex justify-between items-center">
            <div className="text-sm text-gray-600">
              {filteredProducts.length} √ºr√ºn bulundu
            </div>
            <button
              onClick={handleAddProduct}
              className="bg-transparent border-2 border-green-600 text-green-600 px-4 py-2 rounded-lg hover:bg-green-600/10 transition-colors flex items-center space-x-2 font-medium"
            >
              <Icon name="Plus" size={16} />
              <span>Yeni √úr√ºn</span>
            </button>
          </div>
        </div>

        {/* √úr√ºn Listesi */}
        <div className="bg-slate-100 rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          {paginatedProducts.length === 0 ? (
            <div className="text-center py-12">
              <Icon name="Package" size={48} className="mx-auto text-gray-400 mb-4" />
              <h3 className="text-lg font-medium text-gray-900 mb-2">√úr√ºn bulunamadƒ±</h3>
              <p className="text-gray-600 mb-4">Arama kriterlerinizi deƒüi≈ütirmeyi deneyin veya yeni √ºr√ºn ekleyin.</p>
              <button
                onClick={handleAddProduct}
                className="inline-flex items-center space-x-2 px-4 py-2 bg-transparent border-2 border-green-600 text-green-600 rounded-lg hover:bg-green-600/10 transition-colors font-medium"
              >
                <Icon name="Plus" size={16} />
                <span>Yeni √úr√ºn Ekle</span>
              </button>
            </div>
          ) : (
            <>
              {/* √úr√ºn Kartlarƒ± */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6">
                {paginatedProducts.map((product) => (
                  <div key={product.id} className="bg-slate-100 border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    {/* Checkbox ve Durum */}
                    <div className="flex items-center justify-between mb-3">
                      <label className="flex items-center">
                        <input
                          type="checkbox"
                          checked={selectedProducts.includes(product.id)}
                          onChange={(e) => {
                            if (e.target.checked) {
                              setSelectedProducts([...selectedProducts, product.id]);
                            } else {
                              setSelectedProducts(selectedProducts.filter(id => id !== product.id));
                            }
                          }}
                          className="rounded border-gray-300 text-green-600 focus:ring-green-500"
                        />
                      </label>
                      <span className={`px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(product.status)}`}>
                        {getStatusText(product.status)}
                      </span>
                    </div>

                    {/* √úr√ºn Resmi */}
                    <div className="w-full aspect-[5/4] bg-gray-100 rounded-lg mb-3 flex items-center justify-center relative group overflow-hidden">
                      {product.image ? (
                        <>
                          <img src={product.image} alt={product.name} className="w-full h-full object-cover object-center" />
                          {/* Resim Deƒüi≈ütir Overlay */}
                          <div className="absolute inset-0 bg-black bg-opacity-50 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <label className="cursor-pointer text-white text-sm bg-blue-600 px-3 py-1 rounded hover:bg-blue-700 transition-colors">
                              <Icon name="Camera" size={16} className="inline mr-1" />
                              Deƒüi≈ütir
                              <input
                                type="file"
                                accept="image/*"
                                className="hidden"
                                onChange={(e) => handleImageUpload(e, product.id)}
                              />
                            </label>
                          </div>
                        </>
                      ) : (
                        <label className="cursor-pointer flex flex-col items-center text-gray-400 hover:text-gray-600 transition-colors w-full h-full justify-center">
                          <Icon name="Camera" size={24} />
                          <span className="text-xs mt-1">Resim Ekle</span>
                          <input
                            type="file"
                            accept="image/*"
                            className="hidden"
                            onChange={(e) => handleImageUpload(e, product.id)}
                          />
                        </label>
                      )}
                    </div>

                    {/* √úr√ºn Bilgileri */}
                    <div className="space-y-2">
                      <h3 className="font-semibold text-gray-900 truncate">{product.name}</h3>
                      <p className="text-sm text-gray-600">{product.subcategory}</p>
                      
                      {/* Fiyat ve Birim */}
                      <div className="flex items-center justify-between">
                        <span className="text-lg font-bold text-green-600">{formatCurrency(product.price)}</span>
                        <span className="text-sm text-gray-500">/{product.unit}</span>
                      </div>

                      {/* Stok Durumu */}
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-gray-600">Stok: {product.stock}</span>
                        <span className={`px-2 py-1 text-xs font-semibold rounded-full ${getStockStatusColor(product)}`}>
                          {getStockStatusText(product)}
                        </span>
                      </div>

                      {/* A√ßƒ±klama */}
                      {product.description && (
                        <p className="text-xs text-gray-500 line-clamp-2">{product.description}</p>
                      )}
                    </div>

                    {/* ƒ∞≈ülem Butonlarƒ± */}
                    <div className="mt-4 flex space-x-2">
                      <button
                        onClick={() => handleEditProduct(product)}
                        className="flex-1 flex items-center justify-center space-x-1 px-3 py-2 bg-transparent border border-green-600 text-green-600 text-sm rounded hover:bg-green-600/10 transition-colors font-medium"
                      >
                        <Icon name="Edit2" size={14} />
                        <span>D√ºzenle</span>
                      </button>
                      <button
                        onClick={() => handleDeleteProduct(product.id)}
                        className="flex items-center justify-center px-3 py-2 bg-transparent border border-red-600 text-red-600 text-sm rounded hover:bg-red-600/10 transition-colors font-medium"
                      >
                        <Icon name="Trash2" size={14} />
                      </button>
                    </div>
                  </div>
                ))}
              </div>

              {/* Sayfalama */}
              {totalPages > 1 && (
                <div className="bg-gray-50 px-6 py-3 border-t border-gray-200">
                  <div className="flex items-center justify-between">
                    <div className="text-sm text-gray-700">
                      Sayfa {currentPage} / {totalPages} ({filteredProducts.length} √ºr√ºn)
                    </div>
                    <div className="flex space-x-2">
                      <button
                        onClick={() => setCurrentPage(Math.max(1, currentPage - 1))}
                        disabled={currentPage === 1}
                        className="px-3 py-1 text-sm bg-white/80 border border-gray-300 rounded hover:bg-gray-50/80 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        √ñnceki
                      </button>
                      <button
                        onClick={() => setCurrentPage(Math.min(totalPages, currentPage + 1))}
                        disabled={currentPage === totalPages}
                        className="px-3 py-1 text-sm bg-white/80 border border-gray-300 rounded hover:bg-gray-50/80 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        Sonraki
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </>
          )}
        </div>
      </div>

      {/* Yeni Kategori Modal */}
      {showNewCategoryModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999] p-4">
          <div className="bg-slate-100 rounded-lg max-w-md w-full p-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-gray-900">Yeni Kategori Ekle</h3>
              <button
                onClick={() => {
                  setShowNewCategoryModal(false);
                  setNewCategoryName('');
                }}
                className="text-gray-400 hover:text-gray-600"
              >
                <Icon name="X" size={24} />
              </button>
            </div>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Kategori Adƒ±
                </label>
                <input
                  type="text"
                  value={newCategoryName}
                  onChange={(e) => setNewCategoryName(e.target.value)}
                  placeholder="√ñrn: Baharat, ƒ∞√ßecekler, vb."
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  onKeyPress={(e) => e.key === 'Enter' && handleAddCategory()}
                />
              </div>
              
              <div className="flex space-x-3 pt-4">
                <button
                  onClick={() => {
                    setShowNewCategoryModal(false);
                    setNewCategoryName('');
                  }}
                  className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50/80 transition-colors bg-transparent"
                >
                  ƒ∞ptal
                </button>
                <button
                  onClick={handleAddCategory}
                  disabled={!newCategoryName.trim()}
                  className="flex-1 px-4 py-2 bg-transparent border-2 border-blue-600 text-blue-600 rounded-lg hover:bg-blue-600/10 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                  Ekle
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* √úr√ºn Modal */}
      {showProductModal && (
        <UrunModali
          product={editingProduct}
          categories={categories}
          activeCategory={activeTab}
          onClose={() => {
            setShowProductModal(false);
            setEditingProduct(null);
          }}
          onSave={handleSaveProduct}
        />
      )}
    </div>
  );
};

export default UrunYonetimi;
