# ===========================================
# KIRIILMAZLAR PANEL - TESTING PIPELINE
# Comprehensive testing workflow for all environments
# ===========================================

name: ðŸ§ª Testing Pipeline

on:
  push:
    branches: [ main, develop, staging ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'

jobs:
  # ===========================================
  # UNIT TESTING
  # ===========================================
  unit-tests:
    name: ðŸ”¬ Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ§ª Run Unit Tests
      run: npm run test -- --coverage --reporter=verbose
      env:
        CI: true

    - name: ðŸ“Š Coverage Report
      run: |
        echo "## ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
        npm run test:coverage | tail -n +2 >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“¤ Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: unit-tests

  # ===========================================
  # INTEGRATION TESTING
  # ===========================================
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ”— Run Integration Tests
      run: |
        echo "ðŸ”— Running integration tests..."
        npm run test -- --selectProjects=integration
      env:
        CI: true

    - name: ðŸ“Š Integration Test Results
      run: |
        echo "## ðŸ”— Integration Test Results" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All integration tests passed" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # E2E TESTING
  # ===========================================
  e2e-tests:
    name: ðŸŽ­ End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ—ï¸ Build Application
      run: npm run build:dev

    - name: ðŸš€ Start Application
      run: |
        npm run serve &
        sleep 10
        curl -f http://localhost:4173 || exit 1

    - name: ðŸŽ­ Run E2E Tests
      run: |
        echo "ðŸŽ­ Running E2E tests..."
        npm run test -- --selectProjects=e2e
      env:
        CI: true
        BASE_URL: http://localhost:4173

    - name: ðŸ“Š E2E Test Results
      run: |
        echo "## ðŸŽ­ E2E Test Results" >> $GITHUB_STEP_SUMMARY
        echo "âœ… All E2E tests passed" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # PERFORMANCE TESTING
  # ===========================================
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: e2e-tests
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ—ï¸ Build Application
      run: npm run build

    - name: ðŸš€ Start Application
      run: |
        npm run serve &
        sleep 10

    - name: âš¡ Run Lighthouse Performance Audit
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: './.lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true

    - name: ðŸ“Š Performance Report
      run: |
        echo "## âš¡ Performance Test Results" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ Lighthouse audit completed" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ˆ Performance metrics captured" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # ACCESSIBILITY TESTING
  # ===========================================
  accessibility-tests:
    name: â™¿ Accessibility Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ—ï¸ Build Application
      run: npm run build

    - name: ðŸš€ Start Application
      run: |
        npm run serve &
        sleep 10

    - name: â™¿ Run Accessibility Tests
      run: |
        npx @axe-core/cli http://localhost:4173 --exit
      continue-on-error: true

    - name: ðŸ“Š Accessibility Report
      run: |
        echo "## â™¿ Accessibility Test Results" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Accessibility audit completed" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # SECURITY TESTING
  # ===========================================
  security-tests:
    name: ðŸ”’ Security Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ”’ Security Audit
      run: npm audit --audit-level=moderate

    - name: ðŸ” CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript

    - name: ðŸ—ï¸ Build for Analysis
      run: npm run build

    - name: ðŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

    - name: ðŸ“Š Security Report
      run: |
        echo "## ðŸ”’ Security Test Results" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Security audit completed" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ” CodeQL analysis performed" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # TEST SUMMARY
  # ===========================================
  test-summary:
    name: ðŸ“‹ Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, performance-tests, accessibility-tests, security-tests]
    if: always()
    
    steps:
    - name: ðŸ“‹ Generate Test Summary
      run: |
        echo "# ðŸ§ª KÄ±rÄ±lmazlar Panel Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Test Suite Results:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”¬ Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”— Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ­ E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- âš¡ Performance Tests: ${{ needs.performance-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- â™¿ Accessibility Tests: ${{ needs.accessibility-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”’ Security Tests: ${{ needs.security-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ Overall Status: " >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.unit-tests.result }}" == "success" && 
              "${{ needs.integration-tests.result }}" == "success" && 
              "${{ needs.e2e-tests.result }}" == "success" ]]; then
          echo "âœ… **ALL CRITICAL TESTS PASSED**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **SOME TESTS FAILED**" >> $GITHUB_STEP_SUMMARY
        fi
